#!/bin/bash
#
# vim: ft=sh
#
# This script checks whether the last restic backup occurred in a certian timeframe

# timestamp of last snapshot

set -o nounset

export RESTIC_CACHE_DIR={{ cache_dir }}
export RESTIC_PASSWORD={{ password }}
export RESTIC_REPOSITORY={{ repository }}

{% if aws_access_key_id != None -%}
export AWS_ACCESS_KEY_ID={{ aws_access_key_id }}
export AWS_SECRET_ACCESS_KEY={{ aws_secret_access_key }}
{%- endif %}


# Clean things up when exiting
function finish {
  unset RESTIC_CACHE_DIR
  unset RESTIC_PASSWORD
  unset RESTIC_REPOSITORY

  {% if aws_access_key_id != None -%}
  unset AWS_ACCESS_KEY_ID
  unset AWS_SECRET_ACCESS_KEY
  {%- endif %}
}
trap finish EXIT

get_last_backup_timestamp() {
  local last_backup_timestamp

  # NOTE: strptime() of jq can't cope with JavaScript date format, therefore using cut
  last_timestamp=$(jq -r '.[-1].time' | cut -d\. -f1)

  date --date="$last_timestamp" '+%s'
}

get_timestamp_diff() {
  local last_backup_unix=${1:-}
  local now_unix
  local seconds_since_last_backup

  if [ -z "$last_backup_unix" ]; then
    echo "Usage: get_timestamp_diff <timestamp>"
    return 1
  fi

  now_unix=$(date '+%s')
  seconds_since_last_backup=$(expr $now_unix - $last_backup_unix)

  echo $seconds_since_last_backup
}

# Get restic collection status
collection_status=$(timeout -k 600 300 restic snapshots --json)
if [ $? -ne 0 ]; then
  echo "restic collection-status failed:"
  echo "$collection_status"
  echo
  exit 1
fi

# Return with exit code 1 if last backup is too old
last_backup_timestamp=$(echo "$collection_status" | get_last_backup_timestamp)
timestamp_diff=$(get_timestamp_diff $last_backup_timestamp)
if [ $timestamp_diff -gt {{ max_backup_age }} ]; then
  echo "Backup too old ($(date -d @${last_backup_timestamp}))"
  exit 1
fi

exit 0
